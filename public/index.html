<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cute Animals</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5;
        min-height: 100dvh;
      }

      /*
				TODO: add variables for the durations and delays
			*/
      ::view-transition {
        --vt-base-duration: 1s;

        --vt-description-duration: 0.5;
        --vt-description-delay: 0;
      }

      /* Allow cursor to send events to underlying page while a VT is running */
      ::view-transition {
        pointer-events: none;
      }

      /* Apply base duration to all */
      ::view-transition-group(*) {
        animation-duration: var(--vt-base-duration);
      }

      /* Also inherit the delay from the group onto the child pseudos */
      ::view-transition-image-pair(*),
      ::view-transition-new(*),
      ::view-transition-old(*) {
        animation-delay: inherit;
      }

      ::view-transition-old(*) {
        z-index: 2;
      }

      /* Some keyframes to use */
      @keyframes slide-up {
        to {
          translate: 0 -100%;
        }
      }
      @keyframes slide-down {
        from {
          translate: 0 -100%;
        }
      }
      @keyframes fade-out {
        to {
          opacity: 0;
        }
      }
      @keyframes fade-in {
        from {
          opacity: 0;
        }
      }

      :root {
        view-transition-name: none;
      }

      .main-screen {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr 1fr 1fr;
        gap: 20px;
        padding: 20px;
        min-height: 100dvh;
      }

      .main-screen.hide {
        display: none;
      }

      .animal-card {
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        font-weight: 600;
        color: #333;
        cursor: pointer;
        transition: transform 0.2s ease;
        text-align: center;
        text-decoration: none;
      }

      .animal-card:focus {
        outline: 3px solid #0066cc;
        outline-offset: 2px;
        transform: scale(1.02);
      }

      .capybara {
        background: linear-gradient(135deg, #ffe4e1, #fff0f5);
      }
      .main-screen:not(.hide) .capybara {
        view-transition-name: capybara;
      }

      .kitten {
        background: linear-gradient(135deg, #e6f3ff, #f0f8ff);
      }
      .main-screen:not(.hide) .kitten {
        view-transition-name: kitten;
      }

      .bunny {
        background: linear-gradient(135deg, #f0fff0, #f5fffa);
      }
      .main-screen:not(.hide) .bunny {
        view-transition-name: bunny;
      }

      .penguin {
        background: linear-gradient(135deg, #fff8dc, #fffacd);
      }
      .main-screen:not(.hide) .penguin {
        view-transition-name: penguin;
      }

      .detail-screen.capybara.show {
        view-transition-name: capybara;
      }

      .detail-screen.kitten.show {
        view-transition-name: kitten;
      }

      .detail-screen.bunny.show {
        view-transition-name: bunny;
      }

      .detail-screen.penguin.show {
        view-transition-name: penguin;
      }

      .detail-screen {
        display: none;
        min-height: 100vh;
        padding: 40px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        transition: border-radius 0.2s ease;
      }
      .detail-screen.show {
        display: flex;
      }

      .detail-screen h1 {
        font-size: 3rem;
        margin-bottom: 30px;
        color: #333;
      }

      .detail-screen p {
        font-size: 1.2rem;
        line-height: 1.6;
        max-width: 600px;
        color: #555;
        margin-bottom: 30px;
      }

      .close-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
        z-index: 100;
        touch-action: none;
      }

      .close-btn:hover {
        background: rgba(0, 0, 0, 0.9);
      }

      .close-btn:focus {
        outline: 3px solid #0066cc;
        outline-offset: 2px;
        background: rgba(0, 0, 0, 0.9);
      }
    </style>
  </head>
  <body>
    <main id="main-screen" class="main-screen">
      <a href="/capybara" class="animal-card capybara" data-animal="capybara"><span>ü¶´ Capybara</span></a>
      <a href="/kitten" class="animal-card kitten" data-animal="kitten"><span>üê± Kitten</span></a>
      <a href="/bunny" class="animal-card bunny" data-animal="bunny"><span>üê∞ Bunny</span></a>
      <a href="/penguin" class="animal-card penguin" data-animal="penguin"><span>üêß Penguin</span></a>
    </main>

    <article id="capybara-detail" class="detail-screen capybara">
      <button class="close-btn" aria-label="Close and return to main view">
        <img src="/chevron-down.svg" alt="" width="20" height="20" />
      </button>
      <h1>ü¶´ Capybara</h1>
      <p>
        Capybaras are the world's largest rodents and are native to South America. These gentle giants are semi-aquatic
        and love spending time in water. They're incredibly social animals that get along with almost every other
        species, making them nature's diplomats. Capybaras are herbivores and can weigh up to 146 pounds. Their calm
        demeanor and friendly nature have made them beloved around the world, often seen relaxing in hot springs or
        lounging with other animals at zoos.
      </p>
    </article>

    <article id="kitten-detail" class="detail-screen kitten">
      <button class="close-btn" aria-label="Close and return to main view">
        <img src="/chevron-down.svg" alt="" width="20" height="20" />
      </button>
      <h1>üê± Kitten</h1>
      <p>
        Kittens are young domestic cats, typically under one year of age. These adorable creatures are born after a
        gestation period of approximately 64-67 days, usually in litters of 2-5. Kittens are born blind and deaf,
        opening their eyes at around 7-10 days old. They're incredibly playful and curious, using play to develop their
        hunting skills and social behaviors. Kittens purr when they're content and have an amazing ability to land on
        their feet due to their righting reflex. They require lots of love, care, and attention as they grow.
      </p>
    </article>

    <article id="bunny-detail" class="detail-screen bunny">
      <button class="close-btn" aria-label="Close and return to main view">
        <img src="/chevron-down.svg" alt="" width="20" height="20" />
      </button>
      <h1>üê∞ Bunny</h1>
      <p>
        Bunnies, or rabbits, are small mammals known for their long ears, fluffy tails, and powerful hind legs. They're
        herbivores that love munching on grass, vegetables, and hay. Rabbits are incredibly social animals that live in
        groups called colonies in the wild. They communicate through various sounds, body language, and even by thumping
        their hind feet to warn others of danger. Bunnies can jump up to 3 feet high and run up to 35 mph when needed.
        They're also known for their prolific breeding, which is where the phrase "breeding like rabbits" comes from.
      </p>
    </article>

    <article id="penguin-detail" class="detail-screen penguin">
      <button class="close-btn" aria-label="Close and return to main view">
        <img src="/chevron-down.svg" alt="" width="20" height="20" />
      </button>
      <h1>üêß Penguin</h1>
      <p>
        Penguins are flightless birds that have adapted to life in the water. These tuxedo-wearing birds are found
        primarily in the Southern Hemisphere, with the largest populations in Antarctica. They're excellent swimmers,
        using their wings as flippers to propel themselves through water at speeds up to 22 mph. Penguins are highly
        social and often huddle together for warmth in harsh conditions. They're devoted parents, with many species
        taking turns incubating eggs and caring for their chicks. Despite their formal appearance, penguins are quite
        playful and have been observed sliding on their bellies for fun!
      </p>
    </article>

    <script>
      // Boolen that indicates if we are handling a gesture or not
      let activeGesture = false;

      async function onPointerDown(downEvent) {
        console.log("onPointerDown", downEvent);

        // Already handling a gesture or no button pressed? Abort!
        if (activeGesture || !downEvent.buttons) return;

        // Check if target is not a child of .close-btn
        let closeBtn = downEvent.target.closest(".close-btn");
        if (!closeBtn) return;

        // Get screen dimensions
        let screenWidth = window.innerWidth;
        let screenHeight = window.innerHeight;
        let detailScreen = downEvent.target.closest(".detail-screen");

        // Mark that we are handling a gesture
        activeGesture = true;

        // A shared Abort Controller to be passed into each event handler.
        // That way, we can abort them all in one go, by calling .abort() on the instance
        const controller = new AbortController();

        // Prevent text-selection
        document.documentElement.style.userSelect = "none";
        document.documentElement.style.touchAction = "none";

        // Method that gets called upon releasing or cancelling the pointer
        // This method cleans up all listeners, and then snaps the VT (if any) to one of either ends.
        const done = async (upEvent) => {
          console.log("done", upEvent);

          // Only continue if its the same pointerId as from the downEvent
          if (downEvent.pointerId !== upEvent.pointerId) return;

          // Re-enable text-selection
          document.documentElement.style.userSelect = "inherit";
          document.documentElement.style.touchAction = "initial";

          activeGesture = false;

          controller.abort();

          // TODO: start view transition back to home screen or transition
          // back to fullscreen
          showMain(true);
        };

        // Clean up when releasing the pointer
        for (const eventName of ["pointerup", "pointercancel"]) {
          document.addEventListener(eventName, done, { signal: controller.signal });
        }
        // Update the position when moving the pointer
        document.addEventListener(
          "pointercancel",
          (cancelEvent) => {
            console.log(cancelEvent);
          },
          { signal: controller.signal }
        );

        // Update the position when moving the pointer
        document.addEventListener(
          "pointermove",
          (moveEvent) => {
            // Only continue if its the same pointerId as from the downEvent
            if (downEvent.pointerId !== moveEvent.pointerId) return;

            moveEvent.preventDefault();
            moveEvent.stopPropagation();

            // Calculate percentage of screen height
            let percentageY = (moveEvent.screenY / screenHeight) * 100;

            // Calculate clip percentage (invert so dragging down reduces the clip)
            let clipPercentage = Math.max(100 - percentageY, 40);
            let scalePercentage = Math.max(100 - percentageY, 40);

            console.log("percentageY", percentageY, "clipPercentage", clipPercentage);

            if (detailScreen) {
              // Use clip-path to smoothly clip the content
              detailScreen.style.clipPath = `inset(0 0 ${100 - clipPercentage}% 0 round 40px)`;
              detailScreen.style.transform = `scale(${scalePercentage}%)`;
            }
          },
          { signal: controller.signal }
        );
      }

      function showDetail(animal, updateURL = true) {
        document.startViewTransition(() => {
          document.getElementById("main-screen").classList.add("hide");
          document.getElementById(animal + "-detail").classList.add("show");
          document.getElementById(animal + "-detail").style.transform = "";
          document.getElementById(animal + "-detail").style.clipPath = "";
        });

        if (updateURL) {
          history.pushState({ animal }, "", "/" + animal);
        }
      }

      function showMain(updateURL = true) {
        document.startViewTransition(() => {
          document.querySelectorAll(".detail-screen").forEach((screen) => {
            screen.classList.remove("show");
          });
          document.getElementById("main-screen").classList.remove("hide");
        });

        if (updateURL) {
          history.pushState({ main: true }, "", "/");
        }
      }

      function handleRoute() {
        const path = window.location.pathname;
        const validAnimals = ["capybara", "kitten", "bunny", "penguin"];

        if (path === "/") {
          showMain(false);
        } else {
          const animal = path.substring(1); // Remove leading slash
          if (validAnimals.includes(animal)) {
            showDetail(animal, false);
          } else {
            // Invalid route, redirect to home
            history.replaceState({ main: true }, "", "/");
            showMain(false);
          }
        }
      }

      // Handle browser back/forward buttons
      window.addEventListener("popstate", function (event) {
        handleRoute();
      });

      // Handle escape key to close detail view
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          const currentDetailScreen = document.querySelector(".detail-screen.show");
          if (currentDetailScreen) {
            showMain();
          }
        }
      });

      // Add event listeners when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Handle initial route
        handleRoute();

        // Add click handlers for animal cards
        document.querySelectorAll(".animal-card").forEach((card) => {
          card.addEventListener("click", function (event) {
            // Allow default behavior if modifier keys are pressed (cmd+click, ctrl+click, etc)
            if (event.metaKey || event.ctrlKey || event.shiftKey || event.button === 1) {
              return;
            }

            // Prevent default navigation for normal clicks
            event.preventDefault();
            const animal = this.getAttribute("data-animal");
            showDetail(animal);
          });
        });

        // Add click handlers for close buttons
        document.querySelectorAll(".close-btn").forEach((btn) => {
          // btn.addEventListener("click", showMain);
          document.addEventListener("pointerdown", onPointerDown);
        });
      });
    </script>
  </body>
</html>
